@model IEnumerable<ProdutoViewModel>

@{
    ViewData["Title"] = "DIKATATITA - Loja de Porcelanas";
}

<div class="video-section">
    <video autoplay muted loop>
        <source src="~/assets/video/indexp.mp4" type="video/mp4">
        Seu navegador não suporta vídeos.
    </video>

    <div class="search-bar d-flex">
        <form asp-controller="Home" asp-action="Buscar" method="get" class="d-flex w-100">
            <input type="text" placeholder="Pesquisar produtos..." id="search-input" name="termo" value="@ViewBag.TermoBusca" autocomplete="off">
            <button type="submit" class="btn btn-primary search-btn">
                <i class="fas fa-search"></i>
            </button>
        </form>
    </div>
</div>

<div class="main-content container mt-4" id="divParaImprimir">
    @if (ViewBag.TermoBusca != null)
    {
        <div class="row">
            <div class="col-12">
                <h2 class="text-center mb-4">Resultados para: "@ViewBag.TermoBusca"</h2>
                <div class="text-center mb-4">
                    <a href="@Url.Action("Index", "Home")" class="btn btn-outline-secondary">Limpar pesquisa</a>
                </div>
            </div>
        </div>
    }

    <div class="row" id="produtos-container">
        @if (Model.Any())
        {
            @foreach (var item in Model)
            {
                if (item.Ativo && item.QuantidadeEstoque > 0)
                {
                    <div class="col-md-4 mb-4 produto-card" data-nome="@item.Nome.ToLower()">
                        <div class="card h-100 product-card">
                            <img src="~/uploadImagens/@item.Imagem" alt="@item.Nome" class="card-img-top" style="height: 200px; object-fit: cover;">
                            <div class="card-body d-flex flex-column">
                                <h5 class="card-title">@item.Nome</h5>
                                <p class="card-text font-weight-bold">@item.Valor.ToString("C")</p>
                                <p class="card-text text-success">
                                    <i class="fas fa-box me-2"></i>@item.QuantidadeEstoque disponíveis
                                </p>
                                <div class="mt-auto">
                                    <form method="post" class="mt-2">
                                        <input type="hidden" name="produtoId" value="@item.Id" />
                                        <input type="hidden" name="produtoNome" value="@item.Nome" />
                                        <input type="hidden" name="produtoPreco" value="@item.Valor" />
                                        <input type="hidden" name="produtoImagem" value="@item.Imagem" />
                                        <div class="input-group mb-2">
                                            <input type="number" class="form-control quantidade-input" min="1" max="@item.QuantidadeEstoque" value="1" style="max-width: 80px;">
                                        </div>
                                        <button type="button" class="btn btn-warning btn-sm adicionar-ao-carrinho"
                                                data-produto-id="@item.Id"
                                                data-produto-nome="@item.Nome"
                                                data-produto-preco="@item.Valor"
                                                data-produto-imagem="@item.Imagem">
                                            Adicionar ao Carrinho
                                        </button>
                                        <a class="btn btn-info btn-sm" data-toggle="tooltip" data-placement="top" title="Detalhes"
                                        asp-controller="Catalogo" asp-action="Detalhes" asp-route-id="@item.Id">Detalhes</a>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                }
            }
        }
        else
        {
            <div class="col-12 text-center">
                <h3>Nenhum produto encontrado!</h3>
                <p>Tente uma nova busca com termos diferentes.</p>
            </div>
        }
    </div>
</div>

@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', function () {

            function obterCarrinho() {
                const carrinhoCookie = document.cookie.split('; ').find(row => row.startsWith('carrinho='));
                return carrinhoCookie ? JSON.parse(decodeURIComponent(carrinhoCookie.split('=')[1])) : [];
            }

            function salvarCarrinho(carrinho) {
                const carrinhoSerializado = encodeURIComponent(JSON.stringify(carrinho));
                document.cookie = `carrinho=${carrinhoSerializado}; path=/; max-age=${60 * 60 * 24 * 7}`;
            }

            function adicionarAoCarrinho(produto) {
                let carrinho = obterCarrinho();

                const produtoExistente = carrinho.find(item => item.produtoId === produto.produtoId);
                if (produtoExistente) {
                    produtoExistente.quantidade += produto.quantidade;
                } else {
                    carrinho.push({
                        produtoId: produto.produtoId,
                        nome: produto.nome,
                        preco: produto.preco,
                        imagem: `/uploadImagens/${produto.imagem}`, 
                        quantidade: produto.quantidade
                    });
                }

                salvarCarrinho(carrinho);

                const notificacao = document.createElement('div');
                notificacao.className = 'alert alert-success position-fixed bottom-0 end-0 m-3';
                notificacao.style.zIndex = '1000';
                notificacao.textContent = `Adicionado ${produto.quantidade} item(ns) ao carrinho!`;
                document.body.appendChild(notificacao);

                setTimeout(() => {
                    notificacao.remove();
                }, 3000);
            }

            document.querySelectorAll('.adicionar-ao-carrinho').forEach(button => {
                button.addEventListener('click', function () {
                    const produtoId = parseInt(this.getAttribute('data-produto-id'), 10);
                    const nome = this.getAttribute('data-produto-nome');
                    const preco = parseFloat(this.getAttribute('data-produto-preco'));
                    const imagem = this.getAttribute('data-produto-imagem');
                    const inputQuantidade = this.closest('form').querySelector('.quantidade-input');
                    const quantidade = parseInt(inputQuantidade.value, 10) || 1;

                    const produto = {
                        produtoId: produtoId,
                        nome: nome,
                        preco: preco,
                        imagem: imagem,
                        quantidade: quantidade
                    };

                    adicionarAoCarrinho(produto);
                });
            });

            // Manter a busca local (frontend) também para melhor UX
            const searchInput = document.getElementById('search-input');
            if (searchInput) {
                searchInput.addEventListener('input', function() {
                    const termo = this.value.toLowerCase();
                    const produtos = document.querySelectorAll('.produto-card');

                    produtos.forEach(produto => {
                        const nomeProduto = produto.getAttribute('data-nome');
                        if (nomeProduto && nomeProduto.includes(termo)) {
                            produto.style.display = 'block';
                        } else {
                            produto.style.display = 'none';
                        }
                    });
                });
            }
        });
    </script>
}

<style>
    .search-bar {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 60%;
        max-width: 600px;
        z-index: 10;
    }

    .search-bar input {
        padding: 12px;
        border-radius: 30px 0 0 30px;
        border: none;
        width: 100%;
        outline: none;
        font-size: 1.1rem;
        background-color: #fff;
    }

    .search-btn {
        border: none;
        border-radius: 0 30px 30px 0;
        padding: 0 15px;
        background-color: #0077cc;
    }

    .search-btn:hover {
        background-color: #0066bb;
    }
</style>