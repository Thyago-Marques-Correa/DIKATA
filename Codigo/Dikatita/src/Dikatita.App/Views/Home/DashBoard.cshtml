@{
    ViewData["Title"] = "Dashboard - DIKATATITA";
}
<div>
    <h3>Pesquisar Compra</h3>
    <input type="text" id="pesquisa-compra" placeholder="Nome do cliente" />
    <button onclick="pesquisarCompra()">Pesquisar</button>
</div>

<div>
    <h3>Histórico de Compras</h3>
    <input type="text" id="cpf-historico" placeholder="CPF do cliente" />
    <button onclick="carregarHistorico()">Carregar Histórico</button>
</div>

<table id="tabela-compras">
    <thead>
        <tr>
            <th>ID</th>
            <th>Cliente</th>
            <th>Data</th>
            <th>StatusPedido</th>
            <th>Total</th>
            <th>Ações</th>
        </tr>
    </thead>
    <tbody id="compras-body">
    </tbody>
</table>

@section Scripts {
    <script>
        async function carregarCompras() {
            const response = await fetch('/api/compras');
            const data = await response.json();
            const tbody = document.getElementById('compras-body');
            tbody.innerHTML = '';
            data.forEach(compra => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${compra.id}</td>
                    <td>${compra.nomeCliente}</td>
                    <td>${new Date(compra.dataCompra).toLocaleDateString()}</td>
                    <td>${compra.status}</td>
                    <td>R$ ${compra.valorTotal.toFixed(2)}</td>
                    <td><button onclick="editarPedido(${compra.id})">Editar</button></td>
                `;
                tbody.appendChild(row);
            });
        }

        async function pesquisarCompra() {
            const nome = document.getElementById('pesquisa-compra').value;
            const response = await fetch(`/api/compras/buscar?nome=${nome}`);
            const data = await response.json();
            const tbody = document.getElementById('compras-body');
            tbody.innerHTML = '';
            data.forEach(compra => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${compra.id}</td>
                    <td>${compra.nomeCliente}</td>
                    <td>${new Date(compra.dataCompra).toLocaleDateString()}</td>
                    <td>${compra.status}</td>
                    <td>R$ ${compra.valorTotal.toFixed(2)}</td>
                    <td><button onclick="editarPedido(${compra.id})">Editar</button></td>
                `;
                tbody.appendChild(row);
            });
        }

        async function carregarHistorico() {
            const cpf = document.getElementById('cpf-historico').value;
            const response = await fetch(`/api/compras/historico/${cpf}`);
            const data = await response.json();
            const tbody = document.getElementById('compras-body');
            tbody.innerHTML = '';
            data.forEach(compra => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${compra.id}</td>
                    <td>${compra.nomeCliente}</td>
                    <td>${new Date(compra.dataCompra).toLocaleDateString()}</td>
                    <td>${compra.status}</td>
                    <td>R$ ${compra.valorTotal.toFixed(2)}</td>
                    <td><button onclick="editarPedido(${compra.id})">Editar</button></td>
                `;
                tbody.appendChild(row);
            });
        }

        async function editarPedido(id) {
            const novoStatusPedido = prompt("Novo status da compra (Ex.: Finalizado):");
            const response = await fetch(`/api/compras/${id}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ StatusPedido: novoStatusPedido })
            });
            if (response.ok) alert("Pedido atualizado!");
            else alert("Erro ao atualizar o pedido.");
            carregarCompras();
        }

        document.addEventListener('DOMContentLoaded', carregarCompras);
    </script>
}